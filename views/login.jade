doctype html
html
    include ./includes/head.jade
    link(rel='stylesheet' href='https://cdn.jsdelivr.net/npm/ol@v8.1.0/ol.css')
    link(rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.2.1/themes/default/style.min.css")
    title Iniciar sesion
    body(style='background-color: black;')
        #loadingSpinner(class='fixed top-0 left-0 w-screen h-screen flex justify-center items-center bg-white bg-opacity-100 z-50')
            div(class="animate-spin rounded-full border-t-4 border-blue-500 border-solid h-12 w-12")
        section.bg-gray-50(class='dark:bg-gray-900')
            .flex.flex-col.items-center.justify-center.px-6.py-8.mx-auto(class='md:h-screen lg:py-0')
                a.flex.items-center.mb-6.text-2xl.font-semibold.text-gray-900(href='#' class='dark:text-white')
                    img.w-8.h-8.mr-2(src='/assets/img/capdam.ico' alt='logo')
                    p.text-white
                        | SIGCAPDAM
                .w-full.bg-white.rounded-lg.shadow(class='dark:border md:mt-0 sm:max-w-md xl:p-0 dark:bg-gray-800 dark:border-gray-700')
                    .p-6.space-y-4(class='md:space-y-6 sm:p-8')
                        h1.text-xl.font-bold.leading-tight.tracking-tight.text-gray-900(class='md:text-2xl dark:text-white')
                            | Iniciar sesión
                        form.space-y-4(name='login-form' id='login-form' class='md:space-y-6' method='POST')
                            div
                                label.block.mb-2.text-sm.font-medium.text-gray-900(for='email' class='dark:text-white') Correo
                                input#email(type='email' name='email' class='bg-gray-50 border border-gray-300 text-gray-900 sm:text-sm rounded-lg focus:ring-primary-600 focus:border-primary-600 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500')
                            div
                                label.block.mb-2.text-sm.font-medium.text-gray-900(name='password' class='dark:text-white' for='password') Contraseña
                                input#password(type='password' name='password' placeholder='••••••••••' class='bg-gray-50 border border-gray-300 text-gray-900 sm:text-sm rounded-lg focus:ring-primary-600 focus:border-primary-600 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500')
                            div#login-message(class='text-sm text-red-500 font-medium')
                            .flex.items-center.justify-between
                                .flex.items-start
                                    .flex.items-center.h-5
                                        input#remember(type='checkbox' class='w-4 h-4 border border-gray-300 rounded bg-gray-50 focus:ring-3 focus:ring-primary-300 dark:bg-gray-700 dark:border-gray-600 dark:focus:ring-primary-600 dark:ring-offset-gray-800' aria-describedby='remember')
                                    .ml-3.text-sm
                                        label.text-gray-500(for='remember' class='dark:text-gray-300') Mantener la sesión iniciada
                            button.w-full.text-white.bg-primary-600.font-medium.rounded-lg.text-sm.px-5.text-center(type='submit' class='hover:bg-primary-700 focus:ring-4 focus:outline-none focus:ring-primary-300 py-2.5 dark:bg-primary-600 dark:hover:bg-primary-700 dark:focus:ring-primary-800') Entrar
    include ./includes/footer.jade
    script(src='https://cdn.jsdelivr.net/npm/ol@v8.1.0/dist/ol.js')
    script(src="https://code.jquery.com/jquery-3.6.0.min.js")
    script(src="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.3.11/jstree.min.js")
    script.
        document.addEventListener('DOMContentLoaded', function () {

            const form = document.getElementById('login-form');
            const loadingSpinner = document.getElementById('loadingSpinner');
            // Hide spinner on page load after 2 seconds
            setTimeout(() => {
                loadingSpinner.style.display = 'none';
            }, 1000);

            if(localStorage.getItem('token')) {
                window.location.href = '/layers';
            } else {
                localStorage.clear();
            }

            form.addEventListener('submit', async function (event) {
                event.preventDefault();
                const email = document.getElementById('email').value;
                const password = document.getElementById('password').value;
                // Make an Ajax POST request to your login route
                const response = await fetch('/api/v1/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ email, password }),
                });

                const data = await response.json();
                if (!data.success) {
                    const message = document.getElementById('login-message');
                    message.textContent = 'Credenciales incorrectas. Por favor, intenta de nuevo.';
                } else {
                    // Handle successful login (redirect or other actions)
                    const message = document.getElementById('login-message');
                    // Estila el div de mensaje de login y cambia el texto a 'Iniciando sesión...', con colores de éxito
                    message.classList.add('text-green-500', 'font-medium');
                    message.textContent = 'Iniciando sesión...';
                    // Guarda el token en el localStorage
                    localStorage.setItem('token', data.token);
                    localStorage.setItem('udata', data.permissions)
                    // Agrega delay para que se vea el mensaje de login
                    setTimeout(() => {
                        window.location.href = '/layers';
                    }, 2000);
                }
                const loginMessage = document.getElementById('login-message');
                loginMessage.style.display = 'block';
            });
        });